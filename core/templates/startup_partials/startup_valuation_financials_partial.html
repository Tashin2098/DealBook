
{% block content %}
<style>
    .valuation-container {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: #f8f9fa;
    padding: 20px;
    margin: 0;
    height: auto;           /* ✅ let content determine height */
    min-height: auto;       /* ✅ remove forced 100vh */
    overflow: hidden;       /* ✅ prevent scrollbars */
}


    .valuation-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 24px;
        margin-top: 0;
    }

    .content-wrapper {
        max-width: 1400px;
        margin: 0 auto;
    }

    .content-grid {
        display: grid;
        grid-template-columns: minmax(400px, 1fr) minmax(500px, 1.2fr);
        gap: 24px;
        align-items: start;
    }

    .metrics-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        height: fit-content;
        min-width: 0;
    }

    .chart-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 24px;
        min-width: 0;
    }

    .metrics-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }

    .metrics-table thead {
        background: #f7fafc;
        border-bottom: 1px solid #e2e8f0;
    }

    .metrics-table th {
        padding: 14px 18px;
        font-weight: 600;
        font-size: 13px;
        color: #4a5568;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
    }

    .metrics-table th:first-child {
        text-align: left;
    }

    .metrics-table th:last-child {
        text-align: right;
    }

    .metrics-table td {
        padding: 14px 18px;
        border-bottom: 1px solid #f7fafc;
        font-size: 14px;
        border-left: none;
        border-right: none;
        line-height: 1.4;
    }

    .metrics-table tbody tr:last-child td {
        border-bottom: none;
    }

    .metrics-table tbody tr:hover {
        background: #f8f9fa;
        transition: background-color 0.2s ease;
    }

    .metric-label {
        color: #4a5568;
        font-weight: 500;
    }

    .metric-value {
        text-align: right;
        font-weight: 600;
        color: #2d3748;
    }

    .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 18px;
        margin-top: 0;
    }

    .chart-container {
    position: relative;
    width: 100%;
    max-height: 320px;      /* ✅ flexible instead of fixed height */
    min-height: 200px;
}

    /* Highlight key financial metrics */
    .metrics-table tbody tr:nth-child(1) .metric-value,
    .metrics-table tbody tr:nth-child(4) .metric-value,
    .metrics-table tbody tr:nth-child(8) .metric-value {
        color: #667eea;
        font-weight: 700;
    }

    /* Large desktop optimization */
    @media (min-width: 1200px) {
        .content-grid {
            grid-template-columns: 480px 1fr;
            gap: 32px;
        }
        
        .chart-container {
            height: 320px;
        }
    }

    /* Medium screens */
    @media (max-width: 1199px) and (min-width: 769px) {
        .content-grid {
            grid-template-columns: 1fr 1.1fr;
            gap: 20px;
        }
        
        .chart-container {
            height: 260px;
        }
    }

    /* Tablet responsiveness */
    @media (max-width: 968px) {
        .valuation-container {
            padding: 16px;
        }
        
        .content-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .chart-container {
            height: 300px;
        }
        
        .valuation-title {
            font-size: 1.6rem;
        }
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .valuation-container {
            padding: 12px;
        }

        .valuation-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
        }

        .metrics-table th,
        .metrics-table td {
            padding: 12px 14px;
            font-size: 13px;
        }

        .chart-card {
            padding: 18px;
        }

        .chart-container {
            height: 240px;
        }
        
        .chart-title {
            font-size: 1rem;
            margin-bottom: 14px;
        }
    }

    /* Small mobile screens */
    @media (max-width: 600px) {
        .valuation-container {
            padding: 8px;
        }
        
        .valuation-title {
            font-size: 1.3rem;
            margin-bottom: 16px;
        }

        .metrics-table thead {
            display: none;
        }

        .metrics-table,
        .metrics-table tbody,
        .metrics-table tr,
        .metrics-table td {
            display: block;
        }

        .metrics-table tr {
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 14px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metrics-table td {
            padding: 0;
            border: none;
            flex: 1;
            font-size: 13px;
        }

        .metrics-table td:first-child {
            text-align: left;
            padding-right: 10px;
        }

        .metrics-table td:last-child {
            text-align: right;
            flex-shrink: 0;
        }
        
        .chart-card {
            padding: 14px;
        }
        
        .chart-container {
            height: 220px;
        }
    }

    /* Very small screens */
    @media (max-width: 480px) {
        .metrics-table tr {
            padding: 12px;
        }
        
        .metrics-table td {
            font-size: 12px;
        }
        
        .metric-label {
            line-height: 1.3;
        }
        
        .chart-container {
            height: 200px;
        }
    }

    /* Ensure proper scaling */
    @media (max-width: 360px) {
        .valuation-container {
            padding: 6px;
        }
        
        .chart-card {
            padding: 12px;
        }
        
        .chart-container {
            height: 180px;
        }
    }
</style>

<div class="valuation-container">
    <div class="content-wrapper">
        <h1 class="valuation-title">Valuation & Financials</h1>

        <div class="content-grid">
            <!-- SUMMARY TABLE -->
            <div class="metrics-card">
                <table class="metrics-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value (USD)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="metric-label">Annual Recurring Revenue (ARR)</td>
                            <td class="metric-value">${{ profile.arr|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Average Revenue Per User (ARPU)</td>
                            <td class="metric-value">${{ profile.arpu|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Monthly Burn</td>
                            <td class="metric-value">${{ profile.monthly_burn|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Cash Balance</td>
                            <td class="metric-value">${{ profile.cash_balance|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">LTV:CAC Ratio</td>
                            <td class="metric-value">{{ profile.ltv_cac_ratio|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Operating Expenses</td>
                            <td class="metric-value">${{ profile.operating_expenses|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Debt Obligations</td>
                            <td class="metric-value">{{ profile.debt_obligations|default:"—" }}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Capital Raised</td>
                            <td class="metric-value">${{ profile.capital_raised|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Currently Raising</td>
                            <td class="metric-value">${{ profile.currently_raising|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td class="metric-label">Equity Offered</td>
                            <td class="metric-value">{{ profile.equity_offered|floatformat:2 }}%</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- BAR CHART -->
            <div class="chart-card">
                <h2 class="chart-title">Financials Snapshot</h2>
                <div class="chart-container">
                    <canvas id="financialBarChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let financialBarChartInstance = null;

function initFinancialBarChart() {
    const ctx = document.getElementById('financialBarChart');
    if (!ctx) return;

    // Destroy previous chart instance if exists
    if (financialBarChartInstance) {
        financialBarChartInstance.destroy();
    }

    financialBarChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['ARR','ARPU','Burn','Cash','OpEx','Raised','Raising'],
            datasets: [{
                label: 'Amount (USD)',
                data: [
                    {{ profile.arr|default:"0" }},
                    {{ profile.arpu|default:"0" }},
                    {{ profile.monthly_burn|default:"0" }},
                    {{ profile.cash_balance|default:"0" }},
                    {{ profile.operating_expenses|default:"0" }},
                    {{ profile.capital_raised|default:"0" }},
                    {{ profile.currently_raising|default:"0" }}
                ],
                backgroundColor: ['#667eea','#4fd1c7','#f6e05e','#fc8181','#b794f6','#63b3ed','#f687b3'],
                borderRadius: 8,
                barPercentage: 0.7,
                categoryPercentage: 0.8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#e2e8f0',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: false,
                    callbacks: {
                        title: function(tooltipItems) {
                            const fullLabels = {
                                'ARR': 'Annual Recurring Revenue',
                                'ARPU': 'Average Revenue Per User',
                                'Burn': 'Monthly Burn',
                                'Cash': 'Cash Balance',
                                'OpEx': 'Operating Expenses',
                                'Raised': 'Capital Raised',
                                'Raising': 'Currently Raising'
                            };
                            return fullLabels[tooltipItems[0].label] || tooltipItems[0].label;
                        },
                        label: function(context) {
                            return '$' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#f7fafc', drawBorder: false },
                    ticks: {
                        color: '#718096',
                        font: { size: 11 },
                        callback: function(value) {
                            if (value >= 1000000) return '$' + (value/1000000).toFixed(1) + 'M';
                            else if (value >= 1000) return '$' + (value/1000).toFixed(0) + 'K';
                            return '$' + value;
                        }
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#718096', font: { size: 11 }, maxRotation: 45, minRotation: 0 }
                }
            }
        }
    });
}

// Run on full page load
document.addEventListener("DOMContentLoaded", initFinancialBarChart);

// Run when HTMX swaps in this partial
document.body.addEventListener("htmx:afterSwap", function(evt) {
    if (evt.target.querySelector("#financialBarChart")) {
        initFinancialBarChart();
    }
});
</script>

{% endblock %}