{% extends "investor_base.html" %}
{% load humanize %}
{% block content %}

<!-- Tailwind CSS & Google Fonts (for this page only) -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

<style>
  body, .font-sans {
    font-family: 'Montserrat', 'Arial', sans-serif !important;
    background: #faf9f6;
  }
  .gold-bg { background: #B28D4B !important; }
  .gold-text { color: #B28D4B !important; }
  .gold-slider::-webkit-slider-thumb { background: #B28D4B !important; }
  /* For Firefox */
  input[type=range]::-moz-range-thumb { background: #B28D4B !important; }
  /* For IE */
  input[type=range]::-ms-thumb { background: #B28D4B !important; }
</style>

<div class="min-h-screen flex items-center justify-center bg-gray-50 py-8">
  <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl px-10 py-8 overflow-y-auto" style="max-height: 90vh;">
    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
      <h2 class="text-3xl font-bold tracking-tight gold-text mb-2 md:mb-0">Investment Calculator</h2>
      <button type="button" onclick="resetToDefault()" class="border px-4 py-2 rounded gold-text border-yellow-700 hover:bg-yellow-50 transition">Reset to Default</button>
    </div>
    <p class="text-center text-gray-500 mb-6">Estimate your return on investment based on key parameters.</p>
    <!-- Top Parameters -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
      <div>
        <div class="text-sm text-gray-500">Equity Share</div>
        <div id="equity_share_display" class="text-4xl font-extrabold gold-text">{{ default_equity|floatformat:0 }}%</div>
      </div>
      <div>
        <div class="text-sm text-gray-500">Investment Amount</div>
        <div id="investment_amount_display" class="text-4xl font-extrabold">${{ default_investment|floatformat:0 }}</div>
      </div>
      <div>
        <div class="text-sm text-gray-500">Number of Users</div>
        <div id="users_display" class="text-4xl font-extrabold">{{ default_users|floatformat:0 }}</div>
      </div>
    </div>
    <!-- User Slider -->
    <div class="mb-6">
      <label class="block text-gray-700 font-bold mb-2">Number of user accounts</label>
      <input id="users_slider" type="range" min="0" max="2000000" step="10000" value="{{ default_users }}" class="w-full gold-bg h-2 rounded-lg appearance-none cursor-pointer">
      <div class="flex justify-between text-xs text-gray-400 mt-1">
        <span>0</span><span>500k</span><span>1m</span><span>1.5m</span><span>2m</span>
      </div>
      <div class="text-xs text-gray-400 mt-1">recommended 500k</div>
    </div>
    <!-- Estimate Parameters -->
    <div class="bg-gray-50 border rounded-lg p-4 mb-4">
      <h4 class="font-bold mb-2">Estimate Parameters</h4>
      <div class="mb-5">
        <div class="flex justify-between">
          <label class="block text-gray-700 font-bold">Conversion Rate</label>
          <span id="conversion_value" class="font-bold gold-text"></span>
        </div>
        <input id="conversion_slider" type="range" min="10" max="100" step="1" value="{{ default_conversion }}" class="w-full gold-bg h-2 rounded-lg appearance-none cursor-pointer">
        <div class="flex justify-between text-xs text-gray-400 mt-1">
          <span>10%</span><span>30%</span><span>50%</span><span>70%</span><span>100%</span>
        </div>
        <div class="text-xs text-gray-400 mt-1">recommended: 30%-50%</div>
      </div>
      <div>
        <div class="flex justify-between">
          <label class="block text-gray-700 font-bold">Avg Transaction Value</label>
          <span id="avg_txn_value" class="font-bold gold-text"></span>
        </div>
        <input id="avg_txn_slider" type="range" min="50" max="500" step="10" value="{{ default_avg_txn }}" class="w-full gold-bg h-2 rounded-lg appearance-none cursor-pointer">
        <div class="flex justify-between text-xs text-gray-400 mt-1">
          <span>$50</span><span>$150</span><span>$250</span><span>$350</span><span>$500</span>
        </div>
        <div class="text-xs text-gray-400 mt-1">recommended $100</div>
      </div>
    </div>
    <!-- ROI Card -->
    <div class="bg-yellow-50 border-l-8 border-yellow-700 rounded-xl shadow-md p-8 mb-4 flex flex-col items-center">
      <div class="text-gray-500 font-semibold mb-1">Equity in {{ startup.startup_name }}</div>
      <div id="roi_dollar" class="text-5xl font-black gold-text mb-1">$0</div>
      <div class="text-sm text-gray-700">Your Estimated Annual ROI</div>
      <div class="text-gray-500 text-sm"><span id="roi_percent">0%</span> | <span id="roi_multiple">0x</span></div>
    </div>
    <!-- Company Revenue -->
    <div class="text-center mb-3 text-gray-500">
      Est Company Annual Revenue: <span id="company_revenue" class="font-bold gold-text">$0</span>
    </div>
    <div class="mt-4 text-center text-gray-700 text-xs">
      Total Required Investment: $<span id="total_required">{{ default_investment|floatformat:0 }}</span> for <span id="total_equity">{{ default_equity|floatformat:0 }}</span>% equity.
    </div>
    <!-- Invest Now Button -->
    <div class="flex justify-center mt-8">
      <button id="investNowBtn"
              class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg text-lg transition">
        Invest Now
      </button>
    </div>
  </div>
</div>

<!-- Invest Now Modal -->
<div id="investModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl p-8 shadow-xl w-full max-w-md">
    <h3 class="text-xl font-bold mb-4 gold-text">Confirm Investment</h3>
    <form id="investForm" method="POST" action="{% url 'invest_in_company' startup.id %}">
      {% csrf_token %}
      <div class="mb-4">
        <label class="block font-semibold mb-1">Investment Amount ($)</label>
        <input 
          type="number" 
          name="amount" 
          id="input_investment"
          value="{{ default_investment }}"
          class="w-full border rounded p-2" 
          required
        />
      </div>
      <div class="mb-4">
        <label class="block font-semibold mb-1">Equity (%)</label>
        <input 
          type="number" 
          name="equity" 
          id="input_equity"
          value="{{ default_equity }}"
          step="0.1"
          class="w-full border rounded p-2" 
          required
        />
      </div>
      <div class="mb-4">
        <label class="block font-semibold mb-1">Notes (optional)</label>
        <textarea 
          name="notes"
          rows="2"
          class="w-full border rounded p-2"
        ></textarea>
      </div>
      <div class="flex gap-4 justify-end">
        <button type="button" id="cancelModalBtn" class="px-4 py-2 rounded border text-gray-500 hover:bg-gray-100">Cancel</button>
        <button type="submit" class="px-6 py-2 rounded bg-yellow-600 text-white font-bold hover:bg-yellow-700">Confirm Investment</button>
      </div>
    </form>
  </div>
</div>

<script>
function intComma(x) { return x.toLocaleString(); }
function calculate() {
    let users = parseInt(document.getElementById('users_slider').value);
    let conversion = parseFloat(document.getElementById('conversion_slider').value) / 100;
    let avg_txn = parseFloat(document.getElementById('avg_txn_slider').value);
    let equity = parseFloat(document.getElementById('init_equity').value) / 100;
    let investment = parseFloat(document.getElementById('init_investment').value);

    document.getElementById('users_display').innerText = intComma(users);
    document.getElementById('conversion_value').innerText = Math.round(conversion*100) + "%";
    document.getElementById('avg_txn_value').innerText = "$" + intComma(avg_txn);

    let company_revenue = users * conversion * avg_txn;
    document.getElementById('company_revenue').innerText = "$" + intComma(Math.round(company_revenue));
    let investor_profit = company_revenue * equity;
    document.getElementById('roi_dollar').innerText = "$" + intComma(Math.round(investor_profit));
    let roi_percent = investment > 0 ? (investor_profit / investment * 100) : 0;
    let roi_multiple = investment > 0 ? (investor_profit / investment).toFixed(1) : 0;
    document.getElementById('roi_percent').innerText = roi_percent.toFixed(1) + "%";
    document.getElementById('roi_multiple').innerText = roi_multiple + "x";
}
function resetToDefault() {
    document.getElementById('users_slider').value = {{ default_users }};
    document.getElementById('conversion_slider').value = {{ default_conversion }};
    document.getElementById('avg_txn_slider').value = {{ default_avg_txn }};
    calculate();
}
document.addEventListener("DOMContentLoaded", function(){
    ["users_slider", "conversion_slider", "avg_txn_slider"].forEach(function(id){
        document.getElementById(id).addEventListener("input", calculate);
    });
    calculate();

    // Modal logic
    document.getElementById('investNowBtn').onclick = function() {
      // Fill modal with latest values
      document.getElementById('input_investment').value = document.getElementById('init_investment').value;
      document.getElementById('input_equity').value = document.getElementById('init_equity').value;
      document.getElementById('investModal').classList.remove('hidden');
    }
    document.getElementById('cancelModalBtn').onclick = function() {
      document.getElementById('investModal').classList.add('hidden');
    }
});
</script>
<!-- Hidden initial data -->
<input type="hidden" id="init_equity" value="{{ default_equity }}">
<input type="hidden" id="init_investment" value="{{ default_investment }}">

{% endblock %}
